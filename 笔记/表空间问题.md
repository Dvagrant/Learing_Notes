一个 InnoDB 表包含两部分，即：表结构定义和数据。在`MySQL 8.0`版本以前，表结构是存在以.frm 为后缀的文件里。而`MySQL 8.0`版本，则已经允许把表结构定义放在系统数据表中了。


### innodb\_file\_per\_table
表数据可以存在共享表空间，也可以单独存一个文件。
从 MySQL 5.6.6 版本开始，它的默认值就是 ON 。
1. 这个参数设置为 OFF 表示的是，表的数据放在系统共享表空间，也就是跟数据字典放在一起；
2. 这个参数设置为 ON 表示的是，每个 InnoDB 表数据存储在一个以 .ibd 为后缀的文件中。


## 数据文件
InnoDB 删除数据时，是标记删除，标记删除后空间可以复用，当整个页的数据都被标记删除了，数据页就可以复用。

用 delete 命令把整个表的数据删除，结果就是，所有的数据页都会被标记为可复用。但是磁盘上，文件不会变小。

delete 命令其实只是把记录的位置，或者数据页标记为了**可复用**，但磁盘文件的大小是不会变的。也就是说，通过 delete 命令是不能回收表空间的。这些可以复用，而没有被使用的空间，看起来就像是**空洞**。

删除插入都可能造成**空洞**。

经过大量增删改的表，都是可能是存在空洞的。所以，如果能够把这些空洞去掉，就能达到收缩表空间的目的。

## 重建表
使用`alter table A engine=InnoDB`命令来重建表。
- 5.5 版本之前会锁表（防止更新丢失
- 5.5 版本之后引入了`online ddl`

--- 

## online 和 inplace
锁表的 ddl 由于会在 server 层创立临时文件，所以不是 inplace 的。可用`alter table t engine=innodb,ALGORITHM=copy`实现。

5.6 之后的 online ddl 是由 innodb 引擎创建临时表并完成复制转换的，对于 server 层无感知，所以称为 inplace 。即`alter table t engine=innodb,ALGORITHM=inplace`

但 online 和 inplace 是不同的，例如添加全文索引`FULLTEXT index`和空间索引`SPATIAL index`，会阻塞 DML 操作，因此不是 online 的。
- DDL 过程如果是 Online 的，就一定是 inplace 的；
- 反过来未必，也就是说 inplace 的 DDL，有可能不是 Online 的。

---
使用 optimize table、analyze table 和 alter table 这三种方式重建表的区别。
- 从 MySQL 5.6 版本开始，alter table t engine = InnoDB（也就是 recreate）默认的就是 online 的流程了；
- analyze table t 其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了 MDL 读锁；
- optimize table t 等于 recreate+analyze