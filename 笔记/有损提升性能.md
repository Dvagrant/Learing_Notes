## 短链接过多
正常的短连接模式就是连接到数据库后，执行很少的 SQL 语句就断开，下次需要的时候再重连。

MySQL 建立连接的过程，成本是很高的。除了正常的网络连接三次握手外，还需要做登录权限判断和获得这个连接的数据读写权限。

如果使用的是短连接，在业务高峰期的时候，就可能出现连接数突然暴涨的情况。

`max_connections`参数，用来控制一个 MySQL 实例同时存在的连接数的上限，超过这个值，系统就会拒绝接下来的连接请求，并报错提示`Too many connections`。对于被拒绝连接的请求来说，从业务角度看就是数据库不可用。

在机器负载比较高的时候，处理现有请求的时间变长，每个连接保持的时间也更长。这时，再有新建连接的话，就可能会超过`max_connections`的限制。

碰到这种情况时，一个比较自然的想法，就是调高`max_connections`的值。但这样做是有风险的。因为设计`max_connections`这个参数的目的是想保护 MySQL，如果我们把它改得太大，让更多的连接都可以进来，那么系统的负载可能会进一步加大，大量的资源耗费在权限验证等逻辑上，结果可能是适得其反，已经连接的线程拿不到 CPU 资源去执行业务的 SQL 请求。

#### 解决方案1：KILL不工作的线程
通过 show processlist ，踢出状态为 sleep 的线程。
**有时有的线程事务没有断开，但不执行语句也会为sleep状态。通过`information_schema`库的`innodb_trx`表，优先踢出事务外的 sleep 线程**

***一个客户端处于  sleep 状态时，它的连接被服务端主动断开后，这个客户端并不会马上知道。直到客户端在发起下一个请求的时候，才会收到这样的报错`ERROR 2013 (HY000): Lost connection to MySQL server during query`。
有的应用端没有做重连动作，使用旧句柄继续执行 SQL ，会不断返回上面的错误，造成 DB 不可用的错觉。***


#### 解决方案2：减少建立链接的工作
重启数据库，并使用`–skip-grant-tables`参数启动。这样，整个 MySQL 会跳过所有的权限验证阶段，包括连接过程和语句执行过程在内。

在 MySQL 8.0 版本里，如果你启用`–skip-grant-tables`参数，MySQL 会默认把`--skip-networking`参数打开，表示这时候数据库只能被本地的客户端连接。

---
除了短连接数暴增可能会带来性能问题外，在线上碰到更多的是查询或者更新语句导致的性能问题。其中，查询问题比较典型的有两类，一类是由新出现的慢查询导致的，一类是由 QPS（每秒查询数）突增导致的。

## 慢查询
1. 没有加索引。
2. SQL语句逻辑不对，例如索引列加函数使索引失效。
3. 由于事务和RR的原因造成索引统计信息错误。

#### 没有索引时紧急加索引
1. 在备库 B 上执行`set sql_log_bin=off`，也就是不写 binlog，然后执行 alter table 语句加上索引
2. 执行主备切换
3. 这时候主库是 B，备库是 A。在 A 上执行`set sql_log_bin=off`，然后执行 alter table 语句加上索引。

这是一个“古老”的 DDL 方案。平时在做变更的时候，应该考虑类似 gh-ost 这样的方案，更加稳妥。但是在需要紧急处理时，上面这个方案的效率是最高的。

#### 语句逻辑问题，使用`query_rewrite`重写
``` sql
insert into query_rewrite.rewrite_rules
(pattern, replacement, pattern_database) values(old,new,DB)

call query_rewrite.flush_rewrite_rules()
```

#### 索引统计错误时使用`force index`

#### 预先发现问题
1. 上线前，在测试环境，把慢查询日志（slow log）打开，并且把`long_query_time`设置成 0，确保每个语句都会被记录入慢查询日志
2. 在测试表里插入模拟线上的数据，做一遍回归测试
3. 观察慢查询日志里每类语句的输出，特别留意`Rows_examined`字段是否与预期一致

如果新增的 SQL 语句不多，手动跑一下就可以。而如果是新项目的话，或者是修改了原有项目的 表结构设计，全量回归测试都是必要的。这时候，你需要工具帮你检查所有的 SQL 语句的返回结果。比如使用开源工具 pt-query-digest(https://www.percona.com/doc/percona-toolkit/3.0/pt-query-digest.html)。

---
## QPS激增
1. 下线 BUG 业务
2. 白名单，登录用户权限限制
3. 使用重写功能将引起 QPS 激增的语句以`select 1`返回（有损解决